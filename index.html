<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">    
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!--  The library files jquery@3.6.0 ----- --> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
           #loading{
        position :fixed;
        top:0;
        left:0;
        z-index:1000;
        background-color :rgba(250,250,250,0.85);
        height:100vh;
        width:100vw;
      }
      #circle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        width: 100px;
        height: 100px;	
      }
      .loader {
        width: calc(100% - 0px);
        height: calc(100% - 0px);
        border: 8px solid rgba(250,250,250,0.2);
        border-top: 8px solid #09f;
        border-radius: 50%;
        animation: rotate 5s linear infinite;
      }
      @keyframes rotate {
      100% {transform: rotate(360deg);}
      } 
  </style>  
  <title>ระบบทดสอบ</title>
  </head>
  <body>
    <center>
    <h1>Check-In/Out Log</h1>
<div class="btn-group col-12 mb-2">      
  <div id="cin" class=" mx-auto px-2 w-100 invisible" ><button type="button" class="btn btn-success rounded text-white w-100" onclick="getLocationin()">Check-In</button></div>
<!--   <div id="cout" class="mx-auto px-2 invisible"><button  type="button" class="btn btn-danger rounded text-white" onclick="getLocationOut()">Check-Out</button></div> -->
</div>   

<p id="demo"></p>
      <h4>ทดสอบ 12 </h4>      
</center>

    <div id="loading" class="d-flex justify-content-center  align-items-center invisible" >
      <div id="circle">
        <div class="loader">
          <div class="loader">
            <div class="loader">
              <div class="loader">

              </div>
            </div>
          </div>
        </div>
      </div> 
    </div>
    
<script>
    $(window).bind("load", function () {
        $('#loading').addClass('invisible');
      initializeLiff('1657347394-mzWnoBaW');
    });

    function loadingStart(){
        $('#loading').removeClass('invisible');   
    }

    function loadingEnd(){
        $('#loading').addClass('invisible');   
    }
window.onload = function() {
  initializeLiff('1657347394-mzWnoBaW');
}

const xurl = "https://script.google.com/macros/s/AKfycbzt5FXclz6dhtdQm5sTnh0cVbLQ7H7aQdmtnojXov8gOlF1ri3qwum0kr8dsvfx2r7g/exec";

function checks(){

// var today = new Date();
// today.toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })
// var hh = today.getHours();
// var mm = today.getMinutes(); 
//         if(hh <= 13){
//           document.getElementById("cin").classList.remove('invisible');
//         }else if(hh >= 15){
//           document.getElementById("cout").classList.remove('invisible');
//             }else{
// alert("ไม่สามารถเช็คอิน/เอาท์ได้ในช่วงเวลา 13.00-17.00 "+hh+":"+mm);
// liff.closeWindow();  
//             }
// }
  

  // Date time variables
  var dtNow;      
  var dtOpen;    
  var dtClose;   

   
        var openH1 = 5
        var openM1 = 30 
        var openS1 = 0
        var closeH1 = 23
        var closeM1 = 10
        var closeS1 = 59

  dtNow = new Date();
  dtNow.toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })
  console.log(dtNow.getTime())
  dtOpen = new Date(dtNow.getFullYear(), dtNow.getMonth(), dtNow.getDate(), openH1, openM1, openS1);
  console.log(dtOpen.getTime())
  dtClose = new Date(dtNow.getFullYear(), dtNow.getMonth(), dtNow.getDate(), closeH1, closeM1, closeS1);
  console.log(dtClose.getTime())

if(dtNow.getTime() >= dtOpen.getTime() && dtNow.getTime() <= dtClose.getTime()){ 
 document.getElementById("cin").classList.remove('invisible');
 document.getElementById("cout").classList.remove('invisible');
}else{
//         Swal.fire({
//           position: 'center',
//           icon: 'error',
//           title: 'นอกช่วงเวลาลงชื่อ<br>หากพบปัญหาโปรดติดต่อ<br>เจ้าของปฏิบัติการ',
//           showConfirmButton: false,
//           timer: 1500
//         })
   alert("ขณะนี้อยู่นอกช่วงเวลาการลงชื่อ");
//   liff.closeWindow();  
        liff.closeWindow();  
    }
   
}


function initializeLiff(myLiffId) {
    liff
        .init({
            liffId: myLiffId
        })
        .then(() => {
            checks();
        })
        .catch((err) => {
        });
}

var x = document.getElementById("demo");

 function getLocationin() {   
loadingStart()
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition);
    sendMsg()
  } else { 
    x.innerHTML = "Geolocation is not supported by this browser.";
  }
}

function showPosition(position) {
     liff.getProfile().then(function(profile) {
            var uid = profile.userId;
            var uname = profile.displayName;
        var xos = liff.getOS();
        var email = liff.getDecodedIDToken().email;
  x.innerHTML = "Lat: " + position.coords.latitude + 
  "<br>Long: " + position.coords.longitude+ 
  "<br>userId: " + uid+ 
  "<br>displayName: " + uname+
  "<br>your OS: " + xos+
  "<br>your Email: " + email;      
        var xmlhttp = new XMLHttpRequest();
        var theUrl = xurl+"?ctype=In&xos="+xos+"&user="+uid+"&email="+email+"&name="+uname+"&lat="+position.coords.latitude+"&long="+position.coords.longitude;
        xmlhttp.open('GET', theUrl);
        xmlhttp.send();

        xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {        
          var jsonResponse = JSON.parse(this.responseText);    
        }
       loadingEnd()  
        alert(jsonResponse.desc);   
        liff.closeWindow();
      }});  
}

function getLocationOut() {
 loadingStart()
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPositionOut);
     sendMsg() 
  } else { 
    x.innerHTML = "Geolocation is not supported by this browser.";

  }
}

function showPositionOut(position) {
     liff.getProfile().then(function(profile) {
        var uid = profile.userId;
        var uname = profile.displayName;
        var xos = liff.getOS();
        var email = liff.getDecodedIDToken().email;
  x.innerHTML = "Lat: " + position.coords.latitude + 
  "<br>Long: " + position.coords.longitude+ 
  "<br>userId: " + uid+ 
  "<br>displayName: " + uname+
  "<br>your OS: " + xos+
  "<br>your Email: " + email;
var xmlhttp = new XMLHttpRequest();
        var theUrl = xurl+"?ctype=Out&xos="+xos+"&user="+uid+"&email="+email+"&name="+uname+"&lat="+position.coords.latitude+"&long="+position.coords.longitude;
        xmlhttp.open('GET', theUrl);
        xmlhttp.send();
            xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var jsonResponse = JSON.parse(this.responseText);
          
           }
        loadingEnd()
        alert(jsonResponse.desc);

        liff.closeWindow();
      }});  
}
async function sendMsg() {
      now = new Date();
      var thday = new Array ("อาทิตย์","จันทร์",
      "อังคาร","พุธ","พฤหัส","ศุกร์","เสาร์");
      var thmonth = new Array ("มกราคม","กุมภาพันธ์","มีนาคม",
      "เมษายน","พฤษภาคม","มิถุนายน", "กรกฎาคม","สิงหาคม","กันยายน",
      "ตุลาคม","พฤศจิกายน","ธันวาคม");
      var hh = now.getHours();
      var mm = now.getMinutes(); 
      var datenew = "วัน" + thday[now.getDay()]+ "ที่ "+ now.getDate()+ " " +
      thmonth[now.getMonth()]+ " " + (now.getFullYear()+543)+" เวลา "+hh+":"+mm+" น." ;
  if (liff.getContext().type !== "none" && liff.getContext().type !== "external") {
    await liff.sendMessages([
{
  "type": "flex",
  "altText": "Menu",
  "contents": {
    "type": "bubble",
    "body": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "text",
          "text": datenew,
          "weight": "bold",
          "size": "sm",
          "contents": []
        },
        {
          "type": "box",
          "layout": "vertical",
          "spacing": "sm",
          "margin": "lg",
          "contents": [
            {
              "type": "button",
              "action": {
                "type": "uri",
                "label": "ลงชื่อ ณ ปัจจุบัน",
                "uri": "https://liff.line.me/1657347394-mzWnoBaW"
              },
              "style": "primary"
            },
            {
              "type": "button",
              "action": {
                "type": "uri",
                "label": "รายการลงชื่อทั้งหมด",
                "uri": "https://liff.line.me/1657347394-zpkaERNk"
              },
              "color": "#5138E2FF",
              "style": "primary"
            }
          ]
        }
      ]
    },
    "footer": {
      "type": "box",
      "layout": "vertical",
      "flex": 0,
      "spacing": "sm",
      "contents": [
        {
          "type": "spacer",
          "size": "sm"
        }
      ]
    }
  }
}
      
    ])
//     alert("Message sent")
  }
}


</script>



    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script> -->

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
  </body>
</html>
